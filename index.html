<script>
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx7sdWKy6YV6bq33Z4jvrX6Q7eK315xCHfHgtIFFPwy0AZwCfAX8Whm8hjpGM5AHrOVlg/exec";

let reclamationsTable, surveillancesTable, combinedTable;

$(document).ready(function () {
  loadData();

  document.getElementById("refreshBtn").addEventListener("click", loadData);
});

async function loadData() {
  const btn = document.getElementById("refreshBtn");
  const loading = document.getElementById("loading");
  const error = document.getElementById("error");

  btn.innerHTML = "â³ Actualisation en cours...";
  btn.disabled = true;
  loading.style.display = "block";
  error.style.display = "none";

  try {
    const [rRes, sRes] = await Promise.all([
      fetch(APPS_SCRIPT_URL + "?type=reclamations"),
      fetch(APPS_SCRIPT_URL + "?type=surveillances")
    ]);

    if (!rRes.ok || !sRes.ok) throw new Error("API");

    const reclamations = await rRes.json();
    const surveillances = await sRes.json();

    // ğŸ”¹ RÃ©clamations
    if (reclamationsTable) reclamationsTable.clear().rows.add(reclamations.data).draw();
    else {
      reclamationsTable = $('#reclamationsTable').DataTable({
        data: reclamations.data,
        pageLength: 20,
        columns: [
          { data: "Date" },
          { data: "Departement" },
          { data: "Nom" },
          { data: "Email" },
          { data: "Reclamation" },
          { data: "Details" }
        ]
      });
    }

    // ğŸ”¹ Surveillances
    if (surveillancesTable) surveillancesTable.clear().rows.add(surveillances.data).draw();
    else {
      surveillancesTable = $('#surveillancesTable').DataTable({
        data: surveillances.data,
        pageLength: 20,
        columns: [
          { data: "Date" },
          { data: "Nom" },
          { data: "Departement" },
          { data: "Jour" },
          { data: "Email" }
        ]
      });
    }

    // ğŸ”¹ Tableau combinÃ©
    const combined = [
      ...reclamations.data.map(r => ({
        Type: "RÃ©clamation",
        Date: r.Date,
        Nom: r.Nom,
        Departement: r.Departement,
        D1: r.Reclamation,
        D2: r.Details
      })),
      ...surveillances.data.map(s => ({
        Type: "Surveillance",
        Date: s.Date,
        Nom: s.Nom,
        Departement: s.Departement,
        D1: s.Jour,
        D2: s.Email
      }))
    ];

    if (combinedTable) combinedTable.clear().rows.add(combined).draw();
    else {
      combinedTable = $('#combinedTable').DataTable({
        data: combined,
        pageLength: 20,
        columns: [
          { data: "Type" },
          { data: "Date" },
          { data: "Nom" },
          { data: "Departement" },
          { data: "D1" },
          { data: "D2"
