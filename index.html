<script>
  const URL_BASE = "https://script.google.com/macros/s/TON_DEPLOYMENT_ID/exec";

  $(document).ready(async function () {
    try {
      const reclamationsResponse = await fetch(URL_BASE + "?type=reclamations");
      const surveillancesResponse = await fetch(URL_BASE + "?type=surveillances");

      const reclamations = await reclamationsResponse.json();
      const surveillances = await surveillancesResponse.json();

      console.log("Réclamations :", reclamations);
      console.log("Surveillances :", surveillances);

      // TABLE RÉCLAMATIONS
      $('#reclamationsTable').DataTable({
        data: reclamations.data,
        columns: [
          { data: "Date" },
          { data: "Département" },
          { data: "Nom" },
          { data: "Email" },
          { data: "Réclamation" },
          { data: "Précisions" }
        ]
      });

      // TABLE SURVEILLANCES
      $('#surveillancesTable').DataTable({
        data: surveillances.data,
        columns: [
          { data: "Date" },
          { data: "Département" },
          { data: "Nom" },
          { data: "Jour Choisi" }
        ]
      });

      // TABLE COMBINÉE
      const combined = [
        ...reclamations.data.map(r => ({
          Type: "Réclamation",
          Date: r.Date,
          Département: r.Département,
          Nom: r.Nom,
          D1: r.Réclamation,
          D2: r.Précisions
        })),
        ...surveillances.data.map(s => ({
          Type: "Surveillance",
          Date: s.Date,
          Département: s.Département,
          Nom: s.Nom,
          D1: s["Jour Choisi"],
          D2: ""
        }))
      ];

      $('#combinedTable').DataTable({
        data: combined,
        columns: [
          { data: "Type" },
          { data: "Date" },
          { data: "Département" },
          { data: "Nom" },
          { data: "D1" },
          { data: "D2" }
        ]
      });

      // CHART
      createChart(reclamations.data);

    } catch (e) {
      alert("Erreur lors du chargement des données. Vérifiez l'API Google Apps Script.");
      console.error(e);
    }
  });

  function createChart(data) {
    const counts = {};
    data.forEach(item => {
      const dep = item.Département || "Autre";
      counts[dep] = (counts[dep] || 0) + 1;
    });

    new Chart(document.getElementById("chartReclamations"), {
      type: 'bar',
      data: {
        labels: Object.keys(counts),
        datasets: [{
          label: "Réclamations par Département",
          data: Object.values(counts),
          backgroundColor: "rgba(54, 162, 235, 0.6)"
        }]
      },
      options: {
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }
</script>
